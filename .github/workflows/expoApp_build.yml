name: Build Expo Android App (Monorepo + EAS)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      APP_DIR: apps/mobile/datingapp-mobile
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_NO_INTERACTIVE: true
      NODE_ENV: production

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # âœ… Install from monorepo root to maintain workspace links
      - name: ğŸ§¶ Setup Yarn 3
        run: |
          corepack enable
          yarn set version berry
          yarn config set nodeLinker node-modules
          yarn install --mode=update-lockfile

      # âœ… Install EAS CLI globally
      - name: ğŸ“¦ Install EAS CLI
        run: npm install -g eas-cli

      # âœ… Verify Expo installed (debugging info)
      - name: ğŸ” Verify Expo environment
        working-directory: ${{ env.APP_DIR }}
        run: |
          npx expo --version
          node -p "require.resolve('expo/package.json')"

      # âœ… Restore Android keystore
      # - name: ğŸ” Restore Android keystore
      #  working-directory: ${{ env.APP_DIR }}
       # run: |
       #   echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      # âœ… Create credentials.json for EAS
      - name: ğŸ—ï¸ Create credentials.json
        working-directory: ${{ env.APP_DIR }}
        run: |
          cat <<EOF > credentials.json
          {
            "android": {
              "keystore": {
                "keystorePath": "./keystore.jks",
                "keystorePassword": "${{ secrets.KEYSTORE_PASSWORD }}",
                "keyAlias": "${{ secrets.KEY_ALIAS }}",
                "keyPassword": "${{ secrets.KEY_PASSWORD }}"
              }
            }
          }
          EOF

      # âœ… Authenticate with EAS
      - name: ğŸ” Authenticate with Expo
        run: eas whoami || eas login --token $EXPO_TOKEN

      # âœ… (Optional) Cache Gradle to speed up builds
      - name: â˜• Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}

      # âœ… Build Android app
      - name: ğŸ—ï¸ Build Android app with EAS
        working-directory: ${{ env.APP_DIR }}
        run: eas build --platform android --profile production --non-interactive
